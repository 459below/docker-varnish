#/bin/sh

# usage:
#     install_vmod URL [SHA512SUM]
# deps:
#   - varnish development files
#   - curl
#   - pkg-config
#   - build-essential
#   - nproc
#   - whatever dependencies the vmod needs

set -ex

if [ -n "$1" ]; then
	URL="$1"
else
	echo no TARBALL specified
	exit 1
fi

SHA512SUM="$2"

rm -rf /tmp/module_to_build
mkdir /tmp/module_to_build
cd /tmp/module_to_build

curl -fLo src.tar.gz "$URL"
if [ -n "$SHA512SUM" ]; then
	echo "$SHA512SUM  src.tar.gz" | sha512sum -c -
fi
tar xavf src.tar.gz --strip 1

if [ -e autogen.sh ]; then
	./autogen.sh
elif [ -e bootstrap.sh ]; then
	./bootstrap.sh
fi

./configure --libdir="$(pkg-config  --variable=libdir varnishapi)"
make -j"$(nproc)" VERBOSE=1 check
make -j"$(nproc)" VERBOSE=1 install

rm -rf /tmp/module_to_build 
